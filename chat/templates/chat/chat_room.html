<h2>Chat with {{ other_user.username }}</h2>

<div id="chat-log" class="chat-log">
  {% for message in messages %}
    <div class="message">
      <b>{{ message.sender.username }}:</b> {{ message.text }}
    </div>
  {% endfor %}
</div>

<form id="chat-form" class="chat-form">
    <input id="chat-input" type="text" autocomplete="off" class="chat-input" />
    <button type="submit" class="send-button">Send</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomName = "{{ room_name }}";
    const chatLog = document.getElementById('chat-log');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    
    // Establish WebSocket connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    // Handle incoming messages
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.innerHTML = `<b>${escapeHtml(data.username)}:</b> ${escapeHtml(data.message)}`;
        chatLog.appendChild(messageElement);
        chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to bottom
    };

    // Handle connection errors
    chatSocket.onerror = function(error) {
        console.error('WebSocket Error:', error);
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // Handle form submission
    chatForm.onsubmit = function(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        
        if(message !== "" && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            chatInput.value = '';
            chatInput.focus();
        }
    };

    // Basic HTML escaping for security
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
});
</script>

<style>
    .chat-log {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        background: #f9f9f9;
    }
    
    .message {
        margin-bottom: 10px;
        padding: 8px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }
    
    .chat-form {
        display: flex;
        gap: 10px;
    }
    
    .chat-input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .send-button {
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .send-button:hover {
        background: #0069d9;
    }
</style>