{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  :root {
    --primary-color: #6d3bd7;
    --primary-hover: #362fc9;
    --secondary-color: #a78bfa;
    --text-color: #444;
    --light-bg: #f4f5fb;
    --card-bg: #ffffff;
    --border-radius: 14px;
    --shadow: 0 6px 18px rgba(0,0,0,0.08);
    --transition: all 0.3s ease;
  }

  body { font-family: 'Inter', sans-serif; margin: 0; background: var(--light-bg); color: var(--text-color); }

  .chat-wrapper { display: flex; height: 90vh; max-width: 1200px; margin: 20px auto; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; }

  .chat-sidebar { width: 320px; background: #fff; border-right: 1px solid #eee; display: flex; flex-direction: column; }
  .chat-header { padding: 16px; font-size: 1.3rem; font-weight: 700; color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); background: #faf9ff; }
  .chat-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
  .chat-list li { border-bottom: 1px solid #f3f3f3; }
  .chat-link { display: flex; align-items: center; gap: 12px; padding: 14px 16px; text-decoration: none; color: var(--text-color); cursor: pointer; transition: var(--transition); }
  .chat-link:hover { background: #f5f3ff; transform: translateX(4px); }
  .avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--secondary-color); background: #ddd; }
  .chat-info { flex: 1; }
  .username { font-weight: 600; color: #333; }
  .last-message { font-size: 0.85rem; color: #777; }

  .chat-room { flex: 1; display: flex; flex-direction: column; }
  .chat-room-header { padding: 14px 20px; border-bottom: 1px solid #eee; font-weight: 600; font-size: 1.1rem; background: #faf9ff; color: var(--primary-color); }
  .chat-log { flex: 1; padding: 20px; overflow-y: auto; background: var(--light-bg); display: flex; flex-direction: column; gap: 12px; }
  .message { max-width: 65%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.4; }
  .message.me { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
  .message.other { align-self: flex-start; background: #fff; border: 1px solid #eee; color: #333; border-bottom-left-radius: 4px; }
  .chat-form { display: flex; gap: 10px; padding: 14px; border-top: 1px solid #eee; background: #faf9ff; }
  .chat-input { flex: 1; padding: 12px 14px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
  .chat-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(109,59,215,0.2); }
  .send-button { padding: 10px 18px; border-radius: 20px; border: none; background: var(--primary-color); color: #fff; font-weight: 600; cursor: pointer; transition: var(--transition); }
  .send-button:hover { background: var(--primary-hover); transform: translateY(-2px); }
</style>

<div class="chat-wrapper">
  <!-- Sidebar -->
  <div class="chat-sidebar">
    <div class="chat-header">Chats</div>
    <ul class="chat-list">
      {% for user in users %}
        <li>
          <div class="chat-link" data-user-id="{{ user.id }}">
            <img src="{{ user.profile.image.url|default:'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' }}" class="avatar">
            <div class="chat-info">
              <div class="username">{{ user.username }}</div>
              <div class="last-message">Loading...</div>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat Room -->
  <div class="chat-room">
    <div class="chat-room-header">Select a user to start chat</div>
    <div id="chat-log" class="chat-log">
  {% for message in messages %}
    <div class="message">
      <b>{{ message.sender.username }}:</b> {{ message.text }}
    </div>
  {% endfor %}
</div>


    <form id="chat-form" class="chat-form">
      <input id="chat-input" type="text" class="chat-input" placeholder="Type a message..." autocomplete="off">
      <button type="submit" class="send-button">Send</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let chatSocket = null;
  let activeUserId = null;

  const chatLog = document.getElementById('chat-log');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatHeader = document.querySelector('.chat-room-header');
  const chatLinks = document.querySelectorAll('.chat-link');

  const currentUsername = "{{ request.user.username|escapejs }}";
  const currentUserId = parseInt("{{ request.user.id }}");

  function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
  }

  chatLinks.forEach(link => {
    link.addEventListener('click', async () => {
      const userId = parseInt(link.dataset.userId);
      if (activeUserId === userId) return;
      activeUserId = userId;

      chatHeader.textContent = 'Chat with ' + link.querySelector('.username').textContent;
      chatLog.innerHTML = '';

      if (chatSocket) chatSocket.close();

      // Load previous messages via AJAX
      const response = await fetch(`/chat/chat/${userId}/?ajax=1`);
      if (response.ok) {
        const messages = await response.json();
        messages.forEach(m => {
          const div = document.createElement('div');
          div.className = 'message ' + (m.sender === currentUsername ? 'me' : 'other');
          div.innerHTML = `<b>${escapeHtml(m.sender)}:</b> ${escapeHtml(m.text)}`;
          chatLog.appendChild(div);
          // Update last message in sidebar
          link.querySelector('.last-message').textContent = m.text;
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      // Create room_name
      const roomName = [currentUserId, userId].sort((a,b) => a-b).join('_');
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      chatSocket = new WebSocket(`${protocol}//${window.location.host}/ws/chat/${roomName}/`);

      chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const div = document.createElement('div');
        div.className = 'message ' + (data.username === currentUsername ? 'me' : 'other');
        div.innerHTML = `<b>${escapeHtml(data.username)}:</b> ${escapeHtml(data.message)}`;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;

        // Update last message in sidebar
        link.querySelector('.last-message').textContent = data.message;
      };

      chatSocket.onclose = () => console.warn('Chat socket closed');
    });
  });

  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) return;

    const message = chatInput.value.trim();
    if (!message) return;

    chatSocket.send(JSON.stringify({ message }));
    chatInput.value = '';
    chatInput.focus();
  });
});
</script>
{% endblock %}
