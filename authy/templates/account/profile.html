{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
  /* --- Modal styles --- */
  .modal-overlay {
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s forwards;
  }
  .modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    max-width: 450px;
    width: 90%;
    padding: 20px 30px;
    position: relative;
    animation: slideIn 0.3s forwards;
  }

  
    .comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    }

    .comment-item {
        gap: 0.5rem;
    }

    .comment-content {
        background: #f0f2f5;
        padding: 6px 10px;
        border-radius: 18px;
        max-width: 90%;
    }

    .comment-form input[name="content"] {
        padding: 6px 12px;
    }

    .comment-form button {
        padding: 6px 12px;
    }

  .modal h3 { margin-top:0; font-weight:700; color:#6d3bd7; }
  .modal textarea { width:100%; padding:12px; font-size:15px; border-radius:8px; border:1.5px solid #ccc; resize:vertical; transition:border-color 0.3s; }
  .modal textarea:focus { border-color:#6d3bd7; outline:none; }
  .modal-buttons { margin-top:20px; display:flex; justify-content:flex-end; gap:12px; }
  .btn-primary { background-color:#6d3bd7; color:white; border:none; padding:10px 18px; border-radius:8px; font-weight:600; cursor:pointer; transition:background-color 0.25s ease; }
  .btn-primary:hover { background-color:#362fc9; }
  .btn-secondary { background-color:#aaa; color:white; border:none; padding:10px 18px; border-radius:8px; font-weight:600; cursor:pointer; transition:background-color 0.25s ease; }
  .btn-secondary:hover { background-color:#888; }
  @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
  @keyframes slideIn { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }


</style>

<div style="border: solid; border-color: #a78bfa; max-width: 800px; margin: 40px auto; padding: 20px; background-color: rgb(248, 243, 243); color: #5c5c5d; border-radius: 8px; display: flex; justify-content: space-between; align-items: flex-start;">

  <!-- Left: profile info -->
  <div style="display:flex; gap:16px; align-items:center;">
    <!-- Profile Picture -->
    <label for="uploadProfilePic" style="cursor:pointer; display:inline-block; border-radius:50%; border:4px solid #a78bfa; overflow:hidden; width:150px; height:150px;">
      {% if profile.image and profile.image.url %}
        <img src="{{ profile.image.url }}" alt="Profile Picture" style="width:150px;height:150px;object-fit:cover;">
      {% else %}
        <img src="{% static 'profile_pics/default.jpg' %}" alt="Default Profile" style="width:150px;height:150px;object-fit:cover; background:#ddd; padding:20px;">
      {% endif %}
    </label>
    <input type="file" id="uploadProfilePic" style="display:none;">

    <div>
      <h2 style="margin:0; font-weight:700; color:#6d3bd7;">{{ profile_user.get_full_name|default:profile_user.username }}</h2>
      <p style="color:#777; margin-top:4px;">@{{ profile_user.username }}</p>
      <p id="bio-text">{{ profile.bio|default:"No bio yet." }}</p>
      {% if request.user == profile_user %}
        <button id="openBioModalBtn" class="btn-primary" style="margin-top:6px;">Add/Edit Bio</button>
      {% endif %}
    </div>
  </div>

  <!-- Right: followers and buttons -->
  <div style="text-align:right; font-size:14px; color:#7d7b7b;">
    <div><strong>{{ profile_user.follower_relations.count }}</strong> Followers</div>
  <div><strong>{{ profile_user.following_relations.count }}</strong> Following</div>


    {% if request.user != profile_user %}
  <form method="post" action="{% url 'follow_user' profile_user.username %}" style="margin-top:8px;">
    {% csrf_token %}
    {% if is_following %}
      <button type="submit" class="btn btn-danger">Unfollow</button>
    {% else %}
      <button type="submit" class="btn btn-primary">Follow</button>
    {% endif %}
  </form>
{% else %}
  <button id="openPostModalBtn" class="btn-primary" style="margin-top:10px;">Create Post</button>
{% endif %}

  </div>
</div>

<!-- --- Profile Picture Modal --- -->
<div id="picUploadModal" class="modal-overlay">
  <div class="modal">
    <h3>Update Profile Picture</h3>
    <form method="POST" action="{% url 'profile' profile_user.username %}" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="image" accept="image/*" required>
      <div class="modal-buttons">
        <button type="submit" class="btn-primary">Upload</button>
        <button type="button" id="closePicUploadModalBtn" class="btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- --- Bio Modal --- -->
<div id="bioModal" class="modal-overlay">
  <div class="modal">
    <h3>Edit Bio</h3>
    <form method="POST" action="{% url 'profile' profile_user.username %}">
      {% csrf_token %}
      <textarea name="bio" rows="5" placeholder="Write something about yourself...">{{ profile.bio }}</textarea>
      <div class="modal-buttons">
        <button type="submit" class="btn-primary">Save</button>
        <button type="button" id="closeBioModalBtn" class="btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- --- Post Modal --- -->
<div id="postModal" class="modal-overlay">
  <div class="modal">
    <h3>Create New Post</h3>
    <form method="POST" action="{% url 'create_post' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <textarea name="content" rows="5" placeholder="What's on your mind?" required></textarea>
      <input type="file" name="post_image" style="margin-top:10px;">
      <div class="modal-buttons">
        <button type="submit" class="btn-primary">Post</button>
        <button type="button" id="closePostModalBtn" class="btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>


<!-- --- Posts List (Instagram Style) --- -->
<div style="margin-top:40px;">
  <h3>Posts</h3>
  {% for post in profile_user.posts.all|dictsortreversed:"created_at" %}
  <div style="border:1px solid #ccc; border-radius:8px; margin-bottom:20px; background:#fff;">
    <!-- Post Header -->
    <div style="display:flex; align-items:center; padding:10px;">
      <img src="{{ profile.image.url }}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; margin-right:10px;">
      <div>
        <strong>{{ profile_user.username }}</strong><br>
        <small style="color:#777;">{{ post.created_at|date:"M d, Y H:i" }}</small>
      </div>
    </div>

    <!-- Post Content -->
    <div style="padding:0 10px 10px 10px;">
      <p>{{ post.content }}</p>
      {% if post.post_image %}
          <img src="{{ post.post_image.url }}" style="width:100%; border-radius:8px; margin-top:8px;">
      {% endif %}

    </div>

    <!-- Post Actions -->
    <div style="padding:0 10px 10px 10px; display:flex; align-items:center; gap:15px; color:#555;">
      <button class="like-btn" data-post-id="{{ post.id }}" style="border:none; background:none; cursor:pointer;">
        <i class="like-icon {% if user in post.likes.all %}text-primary{% endif %}">‚ù§Ô∏è</i>
        <span class="like-count">{{ post.total_likes }}</span>
      </button>
      <button class="comment-btn" data-post-id="{{ post.id }}">
        üí¨<span class="comment-count">{{ post.comments.count }}</span>
      </button>
    </div>
    
    <!-- Full comments section (hidden initially) -->
      <div class="comments-section" id="comments-{{ post.id }}" style="display:none; margin-top:8px;">
          <div class="comments-list">
              {% for comment in post.comments.all %}
              <div class="d-flex align-items-start mb-2 comment-item">
                  <div class="comment-content bg-light rounded px-2 py-1">
                      <img src="{{ comment.user.profile.image.url|default:'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' }}" class="comment-avatar me-2">

                      <span class="fw-semibold">{{ comment.user.username }}</span>
                      <div>{{ comment.content }}</div>
                      <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                  </div>
              </div>
              {% endfor %}
          </div>

          <!-- Add comment form -->
          <form class="comment-form d-flex align-items-center mt-2" data-post-id="{{ post.id }}">
              {% csrf_token %}
              <img src="{{ user.profile.image.url|default:'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' }}" class="comment-avatar me-2">
              <input type="text" name="content" class="form-control rounded-pill me-2" placeholder="Write a comment..." required>
              <button type="submit" class="btn btn-cirqly btn-sm">Post</button>
          </form>
      </div>

  </div>
{% empty %}
  <p>No posts yet.</p>
{% endfor %}



</div>
 



<script>
  // --- Modal JS ---
  function setupModal(openBtnId, modalId, closeBtnId){
    const modal = document.getElementById(modalId);
    const openBtn = document.getElementById(openBtnId);
    const closeBtn = document.getElementById(closeBtnId);

    if(openBtn){
      openBtn.addEventListener('click', ()=> {
        modal.style.display = 'flex';
      });
    }
    if(closeBtn){
      closeBtn.addEventListener('click', ()=> {
        modal.style.display = 'none';
      });
    }

    window.addEventListener('click', (e)=> {
      if(e.target === modal){
        modal.style.display = 'none';
      }
    });

    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && modal.style.display === 'flex'){
        modal.style.display = 'none';
      }
    });
  }

  // Setup modals
  setupModal('openBioModalBtn','bioModal','closeBioModalBtn');
  setupModal('openPostModalBtn','postModal','closePostModalBtn');
  setupModal('uploadProfilePic','picUploadModal','closePicUploadModalBtn');

  // --- Like button JS ---
  document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', function() {
        const postId = this.dataset.postId;
        fetch("{% url 'like_post' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'post_id=' + postId
        })
        .then(res => res.json())
        .then(data => {
            this.querySelector('.like-count').textContent = data.total_likes;
            if(data.liked){
                this.querySelector('.like-icon').classList.add('text-primary');
            } else {
                this.querySelector('.like-icon').classList.remove('text-primary');
            }
        })
        .catch(console.error);
    });
  });



  
document.querySelectorAll('.comment-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const postId = this.dataset.postId;
        const commentsDiv = document.getElementById('comments-' + postId);
        commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
    });
});

document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', function(e){
        e.preventDefault();
        const postId = this.dataset.postId;
        const input = this.querySelector('input[name="content"]');
        const content = input.value.trim();
        if(!content) return;

        fetch("{% url 'add_comment' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'post_id=' + postId + '&content=' + encodeURIComponent(content)
        })
        .then(res => res.json())
        .then(data => {
            const commentsList = document.querySelector('#comments-' + postId + ' .comments-list');
              // Create new comment div
    const commentDiv = document.createElement('div');
    commentDiv.className = 'd-flex align-items-start mb-2 comment-item';
    
    commentDiv.innerHTML = `
        <img src="${data.user_profile_image}" class="comment-avatar me-2">
        <div class="comment-content bg-light rounded px-2 py-1">
            <div class="fw-semibold">${data.username}</div>
            <div>${data.content}</div>
            <small class="text-muted">just now</small>
        </div>
    `;

      commentsList.appendChild(commentDiv);
    input.value = '';

            // Update preview link
            const previewLink = document.querySelector('.view-comments-link[data-post-id="' + postId + '"]');
            if(previewLink){
                previewLink.textContent = `View all ${data.total_comments} comment${data.total_comments > 1 ? 's' : ''}`;
            }
        })
        .catch(console.error);
    });
});
</script>


{% endblock %}
